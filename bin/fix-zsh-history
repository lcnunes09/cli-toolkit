#!/usr/bin/env bash

HIST_FILE="$HOME/.zsh_history"
BACKUP_FILE="$HIST_FILE.bak.$(date +%Y%m%d%H%M%S)"

echo "ğŸ” Checking for corruption in $HIST_FILE..."

# Check if launching an interactive shell triggers the corruption message
if grep -q "corrupt history file" <(zsh -i -c exit 2>&1); then
  echo "âš ï¸ Detected a corrupted Zsh history file."

  read -p "ğŸ› ï¸  Would you like to repair it now? (y/n): " choice
  if [[ "$choice" == [Yy]* ]]; then
    echo "ğŸ§± Backing up current history to $BACKUP_FILE"
    cp "$HIST_FILE" "$BACKUP_FILE"

    echo "ğŸ§¹ Cleaning up corrupted lines..."
    strings "$BACKUP_FILE" > "$HIST_FILE"

    echo "ğŸ” Reloading history..."
    fc -R "$HIST_FILE"

    echo "âœ… Zsh history has been repaired and reloaded."
  else
    echo "âŒ Repair canceled by user."
  fi
else
  echo "âœ… No corruption detected in your Zsh history."
fi
