#!/bin/bash
# ghstatus - Show Git repo status at a glance

set -euo pipefail

# ── Defaults ──────────────────────────────────────────────
VERBOSE=false
BASE_BRANCH=""
BASE_BRANCHES=("main" "master" "dev")

# ── Parse CLI Arguments ───────────────────────────────────
for (( i=1; i<=$#; i++ )); do
  case "${!i}" in
    --verbose|-v) VERBOSE=true ;;
    --base)
      j=$((i + 1))
      BASE_BRANCH="${!j:-}"
      if [[ -z "$BASE_BRANCH" ]]; then
        echo "❌ Missing value for --base"
        exit 1
      fi
      break
      ;;
  esac
done

# ── Ensure we're inside a Git repo ────────────────────────
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "🚫 Not inside a Git repository."
  exit 1
fi

CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
UNCOMMITTED=$(git status --porcelain)
UNPUSHED_COUNT=$(git log --branches --not --remotes --oneline | wc -l | xargs)
REMOTE=$(git for-each-ref --format='%(upstream:short)' "$(git symbolic-ref -q HEAD)")

# ── Determine base for unmerged detection ─────────────────
TARGET_BRANCH="$BASE_BRANCH"
SHOW_UNMERGED=false

if [[ -n "$BASE_BRANCH" ]]; then
  SHOW_UNMERGED=true
elif [[ " ${BASE_BRANCHES[*]} " =~ " $CURRENT_BRANCH " ]]; then
  TARGET_BRANCH="$CURRENT_BRANCH"
  SHOW_UNMERGED=true
fi

# ── Calculate unmerged branches (if applicable) ───────────
UNMERGED_COUNT=0
TRIMMED_UNMERGED=""

if [[ "$SHOW_UNMERGED" == true ]]; then
  RAW_UNMERGED=$(git branch --no-merged "$TARGET_BRANCH" 2>/dev/null | sed 's/^[* ]*//' | grep -Ev "^(${TARGET_BRANCH})$" || true)
  TRIMMED_UNMERGED=$(echo "$RAW_UNMERGED" | sed '/^\s*$/d')
  UNMERGED_COUNT=$(echo "$TRIMMED_UNMERGED" | wc -l | xargs)
fi

# ── Output ────────────────────────────────────────────────
echo "🧭 Branch: $CURRENT_BRANCH"
echo "📌 Uncommitted changes: $( [ -z "$UNCOMMITTED" ] && echo "no" || echo "yes" )"
echo "⬆️ Unpushed commits: $UNPUSHED_COUNT"
echo "🔗 Remote tracking: ${REMOTE:-none}"

if [[ "$SHOW_UNMERGED" == true ]]; then
  echo "📦 Unmerged branches (into $TARGET_BRANCH): $UNMERGED_COUNT"
fi

if [[ "$VERBOSE" == true ]]; then
  echo ""
  echo "📄 Unpushed commits:"
  git --no-pager log --branches --not --remotes --oneline || echo "✔️ None"

  if [[ "$SHOW_UNMERGED" == true ]]; then
    echo ""
    echo "🌿 Unmerged branches into '$TARGET_BRANCH':"
    if [[ "$UNMERGED_COUNT" -gt 0 ]]; then
      echo "$TRIMMED_UNMERGED"
    else
      echo "✔️ None"
    fi
  fi
fi

echo ""
echo "✅ ghstatus completed!"
