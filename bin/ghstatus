#!/bin/bash
# ghstatus - Show Git repo status at a glance

set -euo pipefail

# ── Parse args ─────────────────────────────────────────────────
VERBOSE=false
for arg in "$@"; do
  [[ "$arg" == "--verbose" || "$arg" == "-v" ]] && VERBOSE=true
done

# ── Ensure we're in a Git repo ─────────────────────────────────
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "🚫 Not inside a Git repository."
  exit 1
fi

# ── Get current Git info ───────────────────────────────────────
CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
UNCOMMITTED=$(git status --porcelain)
UNPUSHED_COUNT=$(git log --branches --not --remotes --oneline | wc -l | xargs)
REMOTE=$(git for-each-ref --format='%(upstream:short)' "$(git symbolic-ref -q HEAD)")

# ── Get unmerged branches ──────────────────────────────────────
RAW_UNMERGED=$(git branch --no-merged "$CURRENT_BRANCH" 2>/dev/null | sed 's/^[* ]*//' | grep -Ev '^(main|master|dev)$' || true)
TRIMMED_UNMERGED=$(echo "$RAW_UNMERGED" | sed '/^\s*$/d')
UNMERGED_COUNT=$(echo "$TRIMMED_UNMERGED" | sed '/^\s*$/d' | wc -l | xargs)

# ── Output ─────────────────────────────────────────────────────
echo "🧭 Branch: $CURRENT_BRANCH"
echo "📌 Uncommitted changes: $( [ -z "$UNCOMMITTED" ] && echo "no" || echo "yes" )"
echo "⬆️ Unpushed commits: $UNPUSHED_COUNT"
echo "📦 Unmerged branches (into $CURRENT_BRANCH): $UNMERGED_COUNT"
echo "🔗 Remote tracking: ${REMOTE:-none}"

if [[ "$VERBOSE" == true ]]; then
  echo ""
  echo "📄 Unpushed commits:"
  if [[ "$UNPUSHED_COUNT" -gt 0 ]]; then
    git --no-pager log --branches --not --remotes --oneline
  else
    echo "✔️ None"
  fi

  echo ""
  echo "🌿 Unmerged branches:"
  if [[ "$UNMERGED_COUNT" -gt 0 ]]; then
    echo "$TRIMMED_UNMERGED"
  else
    echo "✔️ None"
  fi
fi

echo ""
echo "✅ ghstatus completed!"
